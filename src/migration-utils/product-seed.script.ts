// Generated by https://quicktype.io
import axios from 'axios';
import * as casual from 'casual';
import { readFile, writeFile } from 'fs/promises';
import * as path from 'path';
import { ProductAttribute } from '../modules/product/entities/product-attribute.entity';
import { ProductColor } from '../modules/product/entities/product-color.entity';
import { ProductSize } from '../modules/product/entities/product-size.entity';
import { Product } from '../modules/product/entities/product.entity';
import { generateSku } from '../utils/generate-sku.util';
import { translateFromSvToEn } from '../utils/translate-from-sv-to-en';

export interface StayhardResponse {
  category: PurpleCategory;
  sort: Sort[];
  count: Count;
  suggestions: null;
  articles: Article[];
  filters: Filters;
  categories: CategoryElement[];
  pagination: Pagination;
  activeCategories: ActiveCategory[];
}

export interface ActiveCategory {
  name: string;
  slug: string;
  path: string;
}

export interface Article {
  id: string;
  name: string;
  nameSeo: string;
  subBrand: string;
  subBrandSeo: string;
  imageFront: Image;
  rating: string;
  imageAlternative: Image;
  skusData: SkusDatum[];
  labels: Label[];
  energyLabel: null;
  currentPrice: number;
  originalPrice: number;
  discountAmount: number;
  relatedArticles: RelatedArticle[];
}

export interface Image {
  type?: Type;
  card: string;
  detail: string;
  thumb?: string;
}

export enum Type {
  Bm = 'Bm',
  Fm = 'Fm',
}

export interface Label {
  url: string;
  class: Class;
  width: number;
  height: number;
}

export enum Class {
  BottomLeft1 = 'bottomLeft-1',
  TopCenter1 = 'topCenter-1',
  TopRight1 = 'topRight-1',
}

export interface RelatedArticle {
  id: string;
  type: Type;
  image: Image;
}

export interface SkusDatum {
  sku: string;
  size: string;
  inStock: boolean;
}

export interface CategoryElement {
  _meta: Meta;
  slug: string;
  path: string;
  name: string;
  isNewsCategory: boolean;
  count: string;
  selected: boolean;
}

export interface Meta {
  schema: string;
  deliveryId: string;
}

export interface PurpleCategory {
  pageTitle: string;
  pageDescription: string;
  headline: null;
  text: string;
}

export interface Count {
  total: number;
  pageupper: number;
  pagelower: number;
}

export interface Filters {
  brand: Brand;
  color: Color;
  size: Color;
  category: FiltersCategory;
  toggle: Toggle;
}

export interface Brand {
  type: string;
  selected: boolean;
  values: { [key: string]: BrandValue[] };
}

export interface BrandValue {
  count: number;
  hidden: boolean;
  id: string;
  label: string;
  query: string;
  selected: boolean;
  link: string;
  undolink: string;
}

export interface FiltersCategory {
  label: string;
  type: string;
  values: Array<CategoryValue[]>;
}

export interface CategoryValue {
  children: boolean;
  count: number;
  hidden: boolean;
  id: string;
  label: string;
  query: string;
  selected: boolean;
  root: boolean;
  parentId?: ParentID;
}

export enum ParentID {
  ByxorKladerByxorFalse = 'Byxor:klader/byxor:false',
  KläderKladerFalse = 'Kläder:klader:false',
}

export interface Color {
  type: string;
  selected: boolean;
  values: BrandValue[];
}

export interface Toggle {
  id: string;
  label: string;
  values: ToggleValue[];
}

export interface ToggleValue {
  id: string;
  color: string;
  query: string;
  label: string;
  description: string;
  selected: boolean;
}

export interface Pagination {
  current: number;
  next: string;
  last: string;
}

export interface Sort {
  selected: boolean;
  value: string;
  label: string;
  path: string;
}
const colors = [
  'Red',
  'Blue',
  'Black',
  'White',
  'Black',
  'White',
  'Gray',
  'Navy',
  'Brown',
];
const clotheSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

const shoeSizes = ['40', '41', '42', '43', '44', '45'];

const oneSize = 'ONE SIZE';

const clothesSubCategories: Record<string, string> = {
  /*   byxor: 'Pants',
  jackor: 'Jackets',
  'kavaj-kostym': 'Jacket & suit',
  shorts: 'Shorts',
  trojor: 'Sweaters',
  't-shirts-pikeer': 'T-shirts', */
  jeans: 'Jeans',
  'strumpor-underklader': 'Socks & underwear',
  skjortor: 'Shirts',
};

const shoesSubCategories: Record<string, string> = {
  'sneakers-textilskor': 'Sneakers & fabric shoes',
  'boots-kangor': 'Boots',
  'flip-flops-sandaler': 'Flip flops & sandals',
};

const accessoriesSubCategories: Record<string, string> = {
  'mossor-kepsar-hattar': 'Hats & Caps',
  solglasogon: 'Sunglasses',
  'vaskor-planbocker': 'Bags & wallets',
  klockor: 'Watches',
};

const lifestyleSubCategories: Record<string, string> = {
  'face-body': 'Face & Body',
};

const combinedMapOfCategories = {
  klader: {
    ...clothesSubCategories,
  },
  skor: {
    ...shoesSubCategories,
  },
  accessoarer: {
    ...accessoriesSubCategories,
  },
  lifestyle: {
    ...lifestyleSubCategories,
  },
};

type AttributeWithoutProduct = Pick<
  ProductAttribute,
  'color' | 'quantity' | 'size' | 'sku'
>;
export type GeneratedProduct = Pick<
  Product,
  'name' | 'description' | 'originalPrice' | 'currentPrice'
> & {
  images: string[];
  brandName: string;
  attributes: AttributeWithoutProduct[];
};

interface GenerateProductsInput {
  baseCategory: string;
  pageNumber: number;
  subCategory: string;
  categoryInEnglish: string;
}

const generateProducts = async (input: GenerateProductsInput) => {
  try {
    console.log(
      `Calling StayHard API with page number ${input.pageNumber}. Base category is ${input.baseCategory} and sub category: ${input.subCategory}`,
    );
    const response = await axios.get<StayhardResponse>(
      `https://www.stayhard.se/api/articles/?path=%2F${input.baseCategory}%2F${input.subCategory}&page=${input.pageNumber}`,
    );
    const { data } = response;
    if (data.articles.length === 0) {
      console.log('No more data, using the next category');
      return;
    }
    const products: GeneratedProduct[] = [];
    for (const article of data.articles) {
      const translatedName = await translateFromSvToEn(article.name);
      const imageUrls = [
        article.imageFront.detail,
        article.imageAlternative.detail,
        ...article.relatedArticles?.map(
          (relatedArticle) => relatedArticle.image.detail,
        ),
      ];
      const generatedProduct = {
        name: translatedName,
        originalPrice: Math.floor(article.originalPrice / 10), // EUR conversion
        currentPrice: Math.floor(article.currentPrice / 10), // EUR conversion
        images: imageUrls,
        brandName: article.subBrand,
        description: casual.sentences(casual.integer(3, 8)),
        attributes: [
          ...generateAttributes(
            imageUrls.length,
            translatedName,
            input.subCategory,
          ),
        ],
      };
      products.push(generatedProduct);
    }
    const filePath = path.join(
      process.cwd(),
      'src',
      'migration-utils',
      'products.json',
    );
    const currentData = await readFile(filePath).then((d) =>
      JSON.parse(d as unknown as string),
    );
    const mergedData = [
      ...currentData,
      { categoryName: input.categoryInEnglish, products },
    ];
    await writeFile(filePath, JSON.stringify(mergedData));

    await generateProducts({ ...input, pageNumber: input.pageNumber + 1 }); //! recursive
  } catch (err) {
    console.error(err);
  }
};

const generateAttributes = (
  numberOfAttributes: number, // the same amount as length of images
  productName: string,
  subCategory: string,
) => {
  const attributes: any[] = [];
  for (let i = 0; i < numberOfAttributes; i++) {
    // randomly generate between 1 and 3 attributes for the product
    for (let j = 0; j < casual.integer(1, 3); j++) {
      const size = new ProductSize();
      if (clothesSubCategories[subCategory]) {
        size.value = clotheSizes[casual.integer(0, clotheSizes.length - 1)]; // take clothe size
      } else if (shoesSubCategories[subCategory]) {
        size.value = shoeSizes[casual.integer(0, shoeSizes.length - 1)]; // take random shoe size
      } else if (accessoriesSubCategories[subCategory]) {
        size.value = oneSize;
      } else if (lifestyleSubCategories[subCategory]) {
        size.value = oneSize;
      }
      const color = new ProductColor();
      color.value = colors[casual.integer(0, colors.length - 1)];

      const sku = generateSku(productName, color.value, size.value);
      const skuAlreadyExists = attributes.find((a) => a.sku === sku);
      if (skuAlreadyExists) {
        continue; // skip this attribute
      }
      attributes.push({
        size,
        color,
        quantity: casual.integer(1, 100),
        sku,
      });
    }
  }
  return attributes;
};

const main = async () => {
  console.log('Generating products....');
  for (const [baseCategory, subCategories] of Object.entries(
    combinedMapOfCategories,
  )) {
    for (const [swedishCategoryName, englishCategoryName] of Object.entries(
      subCategories,
    ))
      await generateProducts({
        pageNumber: 1,
        baseCategory,
        subCategory: swedishCategoryName,
        categoryInEnglish: englishCategoryName,
      });
  }
};
main();
